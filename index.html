<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA EMERALD V3</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .emerald-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root">
        <div class="flex items-center justify-center h-screen text-slate-400 font-bold animate-pulse">
            INITIALIZING CORE...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. CONFIG (STRICT CHECK) ---
        const SB_URL = 'https://bbgcsddwzcrxwzczrojf.supabase.co'; 
        const SB_KEY = 'sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SB_URL, SB_KEY);
        } catch (e) {
            document.getElementById('root').innerHTML = `<div class="p-10 text-red-500 font-bold">CONFIG ERROR: Check your URL/Key quotes.</div>`;
        }

        function App() {
            const [systems, setSystems] = useState([]);
            const [activeSys, setActiveSys] = useState(null);
            const [notes, setNotes] = useState("");
            const [filter, setFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => { loadData(); }, []);

            async function loadData() {
                try {
                    const { data, error: dbErr } = await supabase.from('systems').select('*').order('id');
                    if (dbErr) throw dbErr;
                    setSystems(data || []);
                    setError(null);
                } catch (e) {
                    setError("Database Connection Failed: " + e.message);
                }
            }

            const filteredData = useMemo(() => {
                return systems.filter(item => {
                    const matchesSearch = item.id.toLowerCase().includes(searchTerm.toLowerCase());
                    const isDone = item.notes || item.has_attachment;
                    if (filter === 'pending') return matchesSearch && !isDone;
                    if (filter === 'cleared') return matchesSearch && isDone;
                    return matchesSearch;
                });
            }, [systems, filter, searchTerm]);

            async function handleSave() {
                if (!activeSys) return;
                setLoading(true);
                const fileInput = document.getElementById('file-upload');
                const files = fileInput?.files;
                let hasAttach = activeSys.has_attachment;

                try {
                    if (files && files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            const fileName = `${activeSys.id}_${Date.now()}_${i}.jpg`;
                            await supabase.storage.from('photos').upload(fileName, files[i]);
                        }
                        hasAttach = true;
                    }
                    await supabase.from('systems').update({ notes, has_attachment: hasAttach }).eq('id', activeSys.id);
                    setActiveSys(null);
                    loadData();
                } catch (e) {
                    alert("Upload Failed: " + e.message);
                } finally {
                    setLoading(false);
                }
            }

            if (error) return <div className="p-20 text-center"><h1 className="text-red-500 font-black text-2xl">{error}</h1><button onClick={() => location.reload()} className="mt-4 bg-slate-900 text-white px-6 py-2 rounded-xl">Retry Connection</button></div>;

            return (
                <div className="min-h-screen pb-20">
                    {/* GIANT SEARCH AREA */}
                    <div className="bg-white border-b p-6 md:p-12">
                        <div className="max-w-screen-2xl mx-auto space-y-8">
                            <div className="flex justify-between items-center">
                                <h1 className="text-4xl font-extrabold tracking-tighter italic">EMERALD<span className="text-emerald-500">QA</span></h1>
                                <button onClick={() => {
                                    const id = prompt("System ID:");
                                    if(id) supabase.from('systems').insert([{id}]).then(loadData);
                                }} className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black text-sm hover:scale-105 transition-transform shadow-xl">ADD UNIT</button>
                            </div>

                            <div className="relative">
                                <input 
                                    className="w-full text-3xl md:text-5xl font-extrabold p-8 bg-slate-100 rounded-[2.5rem] border-none focus:ring-8 focus:ring-emerald-100 outline-none transition-all placeholder:text-slate-200"
                                    placeholder="SEARCH SYSTEM ID..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>

                            <div className="flex gap-4">
                                {['all', 'pending', 'cleared'].map(t => (
                                    <button key={t} onClick={() => setFilter(t)} className={`flex-1 py-5 rounded-2xl text-xs font-black uppercase tracking-[0.2em] transition-all ${filter === t ? 'bg-emerald-500 text-white shadow-2xl shadow-emerald-200' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{t}</button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* DYNAMIC GRID */}
                    <main className="max-w-screen-2xl mx-auto p-6 md:p-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-8">
                        {filteredData.map(s => {
                            const isDone = s.notes || s.has_attachment;
                            return (
                                <div 
                                    key={s.id} 
                                    onClick={() => {setActiveSys(s); setNotes(s.notes || "");}} 
                                    className={`group p-10 rounded-[3rem] cursor-pointer transition-all duration-300 flex flex-col justify-between min-h-[320px] shadow-sm hover:shadow-2xl ${isDone ? 'emerald-gradient text-white shadow-emerald-200' : 'bg-white border-4 border-slate-100 text-slate-800'}`}
                                >
                                    <div className="flex justify-between items-start">
                                        <span className="text-5xl font-black tracking-tighter">#{s.id}</span>
                                        <div className={`p-4 rounded-2xl ${isDone ? 'bg-white/20' : 'bg-slate-50 text-slate-200'}`}>
                                            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d={isDone ? "M5 13l4 4L19 7" : "M12 8v4l3 3"} /></svg>
                                        </div>
                                    </div>
                                    <div>
                                        <p className={`text-xl font-bold leading-tight mb-4 ${isDone ? 'text-emerald-50' : 'text-slate-300'}`}>
                                            {s.notes ? s.notes : "AWAITING DATA..."}
                                        </p>
                                        {s.has_attachment && <div className="text-[10px] font-black uppercase tracking-[0.3em] opacity-60">ðŸ“· MEDIA ATTACHED</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </main>

                    {/* GIANT MODAL EDITOR */}
                    {activeSys && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-2xl flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-4xl rounded-[4rem] p-12 shadow-2xl overflow-y-auto max-h-[95vh] animate-in zoom-in duration-300">
                                <div className="flex justify-between items-center mb-12">
                                    <h2 className="text-6xl font-black tracking-tighter italic text-slate-900">SYS_{activeSys.id}</h2>
                                    <button onClick={() => setActiveSys(null)} className="text-slate-200 hover:text-red-500 transition-colors text-7xl font-light">&times;</button>
                                </div>
                                
                                <div className="space-y-10">
                                    <div>
                                        <label className="text-xs font-black text-slate-300 uppercase tracking-widest block mb-4 italic">// Diagnostic Input</label>
                                        <textarea className="w-full h-64 bg-slate-50 rounded-[3rem] p-10 text-2xl font-bold text-slate-700 focus:ring-8 focus:ring-emerald-50 outline-none transition-all border-none" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="ENTER UNIT STATUS..." />
                                    </div>

                                    <div>
                                        <label className="text-xs font-black text-slate-300 uppercase tracking-widest block mb-4 italic">// Multiple Photo Capture</label>
                                        <div className="bg-emerald-50 border-4 border-dashed border-emerald-100 rounded-[3rem] p-16 text-center relative group hover:bg-emerald-100 transition-all">
                                            <p className="text-emerald-600 font-black text-xl">TAP TO UPLOAD EVIDENCE</p>
                                            <input type="file" id="file-upload" multiple className="absolute inset-0 opacity-0 cursor-pointer" />
                                        </div>
                                    </div>

                                    <button disabled={loading} onClick={handleSave} className="w-full bg-emerald-500 text-white py-8 rounded-[3rem] font-black text-2xl uppercase tracking-[0.2em] shadow-2xl shadow-emerald-200 hover:scale-[1.02] active:scale-95 transition-all">
                                        {loading ? "SYNCING CORE..." : "FINALIZE & SAVE"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
