<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#f8fafc; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const SB_URL = "https://bbgcsddwzcrxwzczrojf.supabase.co";
const SB_KEY = "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f";
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

function App(){

const [systems,setSystems] = useState([]);
const [active,setActive] = useState(null);
const [notes,setNotes] = useState("");
const [photos,setPhotos] = useState([]);
const [status,setStatus] = useState("not_completed");
const [search,setSearch] = useState("");
const [filter,setFilter] = useState("all");
const [loading,setLoading] = useState(false);

/* LOAD SYSTEMS */
useEffect(()=>{ loadSystems(); },[]);

async function loadSystems(){
  const { data, error } = await supabase
    .from("systems")
    .select("*")
    .order("id",{ ascending:true });

  if(error){ console.error(error); return; }
  setSystems(data || []);
}

/* OPEN SYSTEM */
useEffect(()=>{
  if(!active) return;

  setNotes(active.notes || "");
  setStatus(active.status || "not_completed");
  loadPhotos(active.id);
},[active]);

/* LOAD PHOTOS */
async function loadPhotos(systemId){
  const { data } = await supabase
    .storage
    .from("photos")
    .list(systemId);

  if(!data){ setPhotos([]); return; }

  const urls = data.map(file=>{
    const { data:{ publicUrl }} =
      supabase.storage.from("photos")
      .getPublicUrl(`${systemId}/${file.name}`);
    return publicUrl;
  });

  setPhotos(urls);
}

/* SAVE SYSTEM */
async function handleSave(){
  if(!active) return;
  setLoading(true);

  /* UPLOAD PHOTOS */
  const input = document.getElementById("file-upload");
  if(input.files.length){
    for(const file of input.files){
      const path = `${active.id}/${Date.now()}_${file.name}`;
      await supabase.storage
        .from("photos")
        .upload(path,file,{ upsert:true });
    }
  }

  /* AUTO GREEN IF ANY DATA */
  const finalStatus =
    notes.trim() || input.files.length
    ? "completed"
    : status;

  const { error } = await supabase
    .from("systems")
    .update({
      notes,
      status: finalStatus
    })
    .eq("id",active.id);

  if(error){ alert(error.message); }

  input.value="";
  await loadSystems();
  await loadPhotos(active.id);
  setStatus(finalStatus);
  setLoading(false);
}

/* ADD SYSTEM */
async function addSystem(){
  const id = prompt("Enter System Number");
  if(!id) return;

  const cleanId = id.trim();

  const { error } = await supabase
    .from("systems")
    .insert([{
      id: cleanId,
      notes:"",
      status:"not_completed"
    }]);

  if(error){
    alert(error.message);
    return;
  }

  loadSystems();
}

/* DELETE PHOTO */
async function deletePhoto(url){
  const path = url.split("/photos/")[1].split("?")[0];
  await supabase.storage.from("photos").remove([path]);
  loadPhotos(active.id);
}

/* FILTER */
const filtered = systems.filter(s =>
  s.id.toLowerCase().includes(search.toLowerCase()) &&
  (filter==="all" || s.status===filter)
);

return(
<div className="flex h-screen">

{/* SIDEBAR */}
<div className="w-64 bg-white border-r p-4">
<h1 className="text-xl font-bold text-blue-600 mb-4">STS QAQC</h1>

<button
onClick={addSystem}
className="w-full bg-blue-600 text-white py-2 rounded mb-4">
+ Add System
</button>

<div className="space-y-2 text-sm">
<button onClick={()=>setFilter("all")} className="w-full text-left p-2 hover:bg-gray-100 rounded">ğŸ“ All</button>
<button onClick={()=>setFilter("completed")} className="w-full text-left p-2 hover:bg-gray-100 rounded">âœ… Completed</button>
<button onClick={()=>setFilter("not_completed")} className="w-full text-left p-2 hover:bg-gray-100 rounded">âŒ Not Completed</button>
</div>
</div>

{/* MAIN */}
<div className="flex-1 p-6 overflow-y-auto">

<div className="flex gap-4 mb-4">
<input
className="flex-1 border p-3 rounded"
placeholder="Search system..."
onChange={e=>setSearch(e.target.value)}
/>

<select
className="border p-3 rounded"
onChange={e=>setFilter(e.target.value)}>
<option value="all">All</option>
<option value="completed">Completed</option>
<option value="not_completed">Not Completed</option>
</select>
</div>

<div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
{filtered.map(s=>(
<div
key={s.id}
onClick={()=>setActive(s)}
className={`cursor-pointer border rounded-lg p-4
${s.status==="completed"
?"border-green-500 bg-green-50"
:"border-red-400 bg-red-50"}`}>
<div className="font-bold">System #{s.id}</div>
<div className="text-sm mt-2">
{s.status==="completed"
?"ğŸŸ¢ Completed"
:"ğŸ”´ Not Completed"}
</div>
</div>
))}
</div>
</div>

{/* MODAL */}
{active && (
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white w-full max-w-2xl rounded-lg p-6 space-y-4">

<h2 className="text-xl font-bold">System #{active.id}</h2>

<textarea
value={notes}
onChange={e=>setNotes(e.target.value)}
placeholder="Enter notes..."
className="w-full border p-3 rounded h-28"
/>

<input id="file-upload" type="file" multiple accept="image/*" />

<div className="grid grid-cols-3 gap-3">
{photos.map((url,i)=>(
<div key={i} className="relative">
<img src={url} className="h-24 w-full object-cover rounded"/>
<button
onClick={()=>deletePhoto(url)}
className="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 rounded">
âœ•
</button>
</div>
))}
</div>

<div className="flex justify-end gap-3">
<button onClick={()=>setActive(null)} className="px-4 py-2 border rounded">
Close
</button>
<button onClick={handleSave}
className="px-6 py-2 bg-blue-600 text-white rounded">
{loading?"Saving...":"Save"}
</button>
</div>

</div>
</div>
)}

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
