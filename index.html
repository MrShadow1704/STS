<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
.fade { animation: fade .25s ease; }
@keyframes fade {
  from { opacity:0; transform:scale(.95); }
  to { opacity:1; transform:scale(1); }
}
</style>
</head>

<body class="bg-slate-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ✅ CORRECT FOR NEW SUPABASE PROJECTS */
const supabase = window.supabase.createClient(
  "https://bbgcsddwzcrxwzczrojf.supabase.co",
  "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f"
);

/* ================= AUTH ================= */
function Auth({ onAuth }) {
  const [email,setEmail]=useState("");
  const [pass,setPass]=useState("");
  const [mode,setMode]=useState("login");
  const [msg,setMsg]=useState("");
  const [loading,setLoading]=useState(false);

  async function submit(){
    setMsg("");
    setLoading(true);
    try{
      if(mode==="signup"){
        const { error } = await supabase.auth.signUp({
          email,
          password: pass
        });
        if(error) throw error;
        setMsg("✅ Account created successfully. Please login.");
        setMode("login");
      } else {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password: pass
        });
        if(error) throw error;
        onAuth(data.user);
      }
    } catch(e){
      if(e.message.includes("Invalid login"))
        setMsg("❌ Invalid email or password");
      else if(e.message.includes("already registered"))
        setMsg("⚠️ User already exists");
      else
        setMsg("❌ " + e.message);
    }
    setLoading(false);
  }

  return (
    <div className="h-screen flex items-center justify-center">
      <div className="bg-white w-96 p-8 rounded-3xl shadow-xl fade space-y-4">
        <h1 className="text-2xl font-bold text-center text-blue-600">
          STS QAQC
        </h1>

        <input
          className="w-full border p-3 rounded-xl"
          placeholder="Email"
          value={email}
          onChange={e=>setEmail(e.target.value)}
        />

        <input
          type="password"
          className="w-full border p-3 rounded-xl"
          placeholder="Password"
          value={pass}
          onChange={e=>setPass(e.target.value)}
        />

        {msg && (
          <div className="text-sm text-center text-gray-700">
            {msg}
          </div>
        )}

        <button
          disabled={loading}
          onClick={submit}
          className="w-full bg-blue-600 text-white p-3 rounded-xl disabled:opacity-60"
        >
          {loading ? "Please wait..." : mode==="login" ? "Login" : "Create Account"}
        </button>

        <button
          onClick={()=>setMode(mode==="login"?"signup":"login")}
          className="w-full text-sm text-blue-600"
        >
          {mode==="login"
            ? "New user? Create account"
            : "Already have an account? Login"}
        </button>
      </div>
    </div>
  );
}

/* ================= DASHBOARD ================= */
function Dashboard({ user }) {
  return (
    <div className="h-screen flex flex-col items-center justify-center space-y-4">
      <h2 className="text-2xl font-bold text-green-600">
        ✅ Login successful
      </h2>
      <p className="text-lg">
        Welcome, <b>{user.email}</b>
      </p>
      <button
        onClick={()=>supabase.auth.signOut()}
        className="px-6 py-3 bg-red-500 text-white rounded-xl"
      >
        Logout
      </button>
    </div>
  );
}

/* ================= ROOT ================= */
function Root(){
  const [user,setUser]=useState(null);
  const [ready,setReady]=useState(false);

  useEffect(()=>{
    supabase.auth.getUser().then(res=>{
      setUser(res.data.user);
      setReady(true);
    });

    const { data: listener } =
      supabase.auth.onAuthStateChange((_,session)=>{
        setUser(session?.user || null);
      });

    return ()=>listener.subscription.unsubscribe();
  },[]);

  if(!ready) return null;
  return user ? <Dashboard user={user}/> : <Auth onAuth={setUser}/>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<Root/>);
</script>
</body>
</html>
