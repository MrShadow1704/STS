<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#f8fafc; }
.sidebar-bg{
  background:linear-gradient(180deg,#ffffff 0%,#f1f5f9 100%);
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const SB_URL = "https://bbgcsddwzcrxwzczrojf.supabase.co";
const SB_KEY = "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f";
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

function App(){

const [systems,setSystems] = useState([]);
const [active,setActive] = useState(null);
const [notes,setNotes] = useState("");
const [photos,setPhotos] = useState([]);
const [status,setStatus] = useState("not_completed");
const [search,setSearch] = useState("");
const [filter,setFilter] = useState("all");
const [loading,setLoading] = useState(false);
const [showAdd,setShowAdd] = useState(false);
const [newId,setNewId] = useState("");

/* LOAD SYSTEMS */
useEffect(()=>{ loadSystems(); },[]);
async function loadSystems(){
  const { data } = await supabase.from("systems").select("*").order("id");
  setSystems(data||[]);
}

/* REALTIME */
useEffect(()=>{
  const channel = supabase
    .channel("systems-live")
    .on("postgres_changes",{event:"*",schema:"public",table:"systems"},()=>loadSystems())
    .subscribe();
  return()=>supabase.removeChannel(channel);
},[]);

/* ACTIVE */
useEffect(()=>{
  if(!active) return;
  setNotes(active.notes||"");
  setStatus(active.status||"not_completed");
  loadPhotos(active.id);
},[active]);

/* PHOTOS */
async function loadPhotos(id){
  const { data } = await supabase.storage.from("photos").list(id);
  if(!data){setPhotos([]);return;}
  setPhotos(data.map(f=>{
    const {data:{publicUrl}} =
      supabase.storage.from("photos").getPublicUrl(`${id}/${f.name}`);
    return publicUrl;
  }));
}

async function deletePhoto(url){
  const path = url.split("/photos/")[1];
  await supabase.storage.from("photos").remove([path]);
  loadPhotos(active.id);
}

/* SAVE */
async function handleSave(){
  setLoading(true);
  const input=document.getElementById("file-upload");

  if(input.files.length){
    for(const f of input.files){
      const path=`${active.id}/${Date.now()}_${f.name}`;
      await supabase.storage.from("photos").upload(path,f,{upsert:true});
    }
  }

  const finalStatus =
    notes.trim()||input.files.length ? "completed":"not_completed";

  await supabase.from("systems")
    .update({notes,status:finalStatus})
    .eq("id",active.id);

  input.value="";
  setStatus(finalStatus);
  loadPhotos(active.id);
  setLoading(false);
}

/* ADD SYSTEM */
async function createSystem(){
  if(!newId.trim()) return;
  await supabase.from("systems").insert([{id:newId.trim(),notes:"",status:"not_completed"}]);
  setNewId(""); setShowAdd(false);
}

/* FILTER */
const filtered=systems.filter(s=>
  s.id.toLowerCase().includes(search.toLowerCase()) &&
  (filter==="all"||s.status===filter)
);

return(
<div className="flex h-screen">

{/* SIDEBAR */}
<div className="w-80 sidebar-bg border-r p-6 flex flex-col">
<h1 className="text-2xl font-bold text-blue-600">STS QAQC</h1>
<p className="text-sm text-gray-500 mb-6">Quality Assurance Dashboard</p>

<button onClick={()=>setShowAdd(true)}
className="bg-blue-600 text-white py-3 rounded-xl font-semibold mb-6">
+ Add System
</button>

<div className="space-y-3 text-base">
<button onClick={()=>setFilter("all")} className="sidebarBtn">ğŸ“ All Systems</button>
<button onClick={()=>setFilter("completed")} className="sidebarBtn">âœ… Completed</button>
<button onClick={()=>setFilter("not_completed")} className="sidebarBtn">âŒ Not Completed</button>
</div>

<div className="mt-auto rounded-2xl bg-gradient-to-br from-blue-100 to-indigo-200 p-6 text-sm text-gray-700">
<strong>Live QA/QC Platform</strong>
<ul className="mt-2 space-y-1">
<li>â€¢ Realtime Collaboration</li>
<li>â€¢ Photo Evidence</li>
<li>â€¢ System Tracking</li>
</ul>
</div>
</div>

{/* MAIN */}
<div className="flex-1 p-8 overflow-y-auto">

<div className="flex gap-4 mb-6">
<input className="flex-1 border p-4 rounded-xl"
placeholder="Search system..."
onChange={e=>setSearch(e.target.value)}/>
<select className="border p-4 rounded-xl" onChange={e=>setFilter(e.target.value)}>
<option value="all">All</option>
<option value="completed">Completed</option>
<option value="not_completed">Not Completed</option>
</select>
</div>

<div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6">
{filtered.map(s=>(
<div key={s.id} onClick={()=>setActive(s)}
className={`cursor-pointer p-5 rounded-2xl border shadow-sm hover:shadow-lg transition
${s.status==="completed"?"bg-green-50 border-green-500":"bg-red-50 border-red-400"}`}>
<h3 className="font-bold text-lg">System #{s.id}</h3>
<p className="mt-2 text-sm">
{s.status==="completed"?"ğŸŸ¢ Completed":"ğŸ”´ Not Completed"}
</p>
</div>
))}
</div>
</div>

{/* SYSTEM MODAL */}
{active&&(
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white w-full max-w-3xl rounded-3xl p-8 shadow-2xl space-y-5">

<h2 className="text-2xl font-bold">System #{active.id}</h2>

<textarea value={notes} onChange={e=>setNotes(e.target.value)}
className="w-full border p-4 rounded-2xl h-32"
placeholder="Inspection notes..."/>

<input id="file-upload" type="file" multiple />

<div className="grid grid-cols-3 gap-4">
{photos.map((url,i)=>(
<div key={i} className="border rounded-2xl p-2">
<img src={url} className="h-28 w-full object-cover rounded-xl"/>
<div className="flex justify-between mt-2">
<a href={url} download
className="flex-1 mr-1 bg-blue-600 text-white py-2 rounded-lg text-sm text-center">
â¬‡ Download
</a>
<button onClick={()=>deletePhoto(url)}
className="flex-1 ml-1 bg-red-600 text-white py-2 rounded-lg text-sm">
ğŸ—‘ Delete
</button>
</div>
</div>
))}
</div>

<div className="flex justify-end gap-4">
<button onClick={()=>setActive(null)} className="px-5 py-3 border rounded-xl">Close</button>
<button onClick={handleSave}
className="px-6 py-3 bg-blue-600 text-white rounded-xl">
{loading?"Saving...":"Save"}
</button>
</div>

</div>
</div>
)}

{/* ADD SYSTEM MODAL */}
{showAdd&&(
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white w-96 rounded-3xl p-6 shadow-2xl space-y-4">
<h2 className="text-xl font-bold">Add New System</h2>
<input value={newId} onChange={e=>setNewId(e.target.value)}
className="w-full border p-4 rounded-2xl" placeholder="System Number"/>
<div className="flex justify-end gap-3">
<button onClick={()=>setShowAdd(false)} className="px-4 py-2 border rounded-xl">Cancel</button>
<button onClick={createSystem} className="px-6 py-2 bg-blue-600 text-white rounded-xl">Add</button>
</div>
</div>
</div>
)}

</div>
);
}

function sidebarBtn({children}){}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
