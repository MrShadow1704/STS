<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#0f172a; color:#e5e7eb; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const SB_URL = "https://bbgcsddwzcrxwzczrojf.supabase.co";
const SB_KEY = "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f";
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

function App(){
const [systems,setSystems] = useState([]);
const [active,setActive] = useState(null);
const [notes,setNotes] = useState("");
const [photos,setPhotos] = useState([]);
const [status,setStatus] = useState("not_completed");
const [search,setSearch] = useState("");
const [filter,setFilter] = useState("all");
const [loading,setLoading] = useState(false);

/* LOAD SYSTEMS */
useEffect(()=>{ loadSystems(); },[]);

async function loadSystems(){
  const {data,error} = await supabase
    .from("systems")
    .select("*")
    .order("id");

  if(error) console.error(error);
  setSystems(data || []);
}

/* OPEN SYSTEM */
function openSystem(id){
  const fresh = systems.find(s=>s.id===id);
  setActive(fresh);
}

/* ACTIVE EFFECT */
useEffect(()=>{
  if(active){
    setNotes(active.notes || "");
    setStatus(active.status || "not_completed");
    fetchPhotos(active.id);
  } else {
    setPhotos([]);
  }
},[active]);

/* FETCH PHOTOS */
async function fetchPhotos(id){
  const {data,error} = await supabase.storage.from("photos").list(id);
  if(error || !data){ setPhotos([]); return; }

  const urls = data.map(f=>{
    const {data:{publicUrl}} =
      supabase.storage.from("photos")
        .getPublicUrl(`${id}/${f.name}`);
    return publicUrl + `?t=${Date.now()}`;
  });

  setPhotos(urls);
}

/* DELETE PHOTO */
async function deletePhoto(url){
  const path = url.split("/photos/")[1].split("?")[0];
  await supabase.storage.from("photos").remove([path]);
  fetchPhotos(active.id);
}

/* SAVE SYSTEM */
async function handleSave(){
  setLoading(true);

  const input = document.getElementById("file-upload");
  const files = input.files;

  let hasPhotos = photos.length > 0;

  if(files && files.length){
    for(let f of files){
      const path = `${active.id}/${Date.now()}_${f.name}`;
      await supabase.storage.from("photos").upload(path,f,{upsert:true});
      hasPhotos = true;
    }
  }

  const newStatus =
    notes.trim() || hasPhotos ? "completed" : "not_completed";

  await supabase.from("systems")
    .update({ notes, status:newStatus })
    .eq("id",active.id);

  input.value="";
  await loadSystems();
  await fetchPhotos(active.id);
  setStatus(newStatus);
  setLoading(false);
}

/* ADD SYSTEM */
async function addSystem(){
  const id = prompt("Enter System Number");
  if(!id) return;

  const {error} = await supabase.from("systems")
    .insert([{ id:id.trim(), notes:"", status:"not_completed" }]);

  if(error){
    alert("System already exists");
    return;
  }

  loadSystems();
}

/* FILTER */
const filtered = systems.filter(s =>
  s.id.toLowerCase().includes(search.toLowerCase()) &&
  (filter==="all" || s.status===filter)
);

return(
<div className="flex h-screen">

{/* SIDEBAR */}
<div className="w-64 bg-slate-950 border-r border-slate-800 p-4 space-y-4">
<h1 className="text-xl font-bold text-emerald-400">STS QAQC</h1>

<button onClick={addSystem}
className="w-full bg-emerald-600 py-2 rounded-lg font-semibold">
+ Add System
</button>

<div className="space-y-2 text-sm">
<Btn label="ðŸ“ All Systems" onClick={()=>setFilter("all")}/>
<Btn label="âœ… Completed" onClick={()=>setFilter("completed")}/>
<Btn label="âŒ Not Completed" onClick={()=>setFilter("not_completed")}/>
</div>
</div>

{/* MAIN */}
<div className="flex-1 p-6 overflow-y-auto">

<div className="flex gap-4 mb-6">
<input
placeholder="Search system number..."
className="flex-1 bg-slate-800 p-3 rounded-lg"
onChange={e=>setSearch(e.target.value)}
/>

<select
className="bg-slate-800 p-3 rounded-lg"
onChange={e=>setFilter(e.target.value)}>
<option value="all">All</option>
<option value="completed">Completed</option>
<option value="not_completed">Not Completed</option>
</select>
</div>

<div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
{filtered.map(s=>(
<div key={s.id}
onClick={()=>openSystem(s.id)}
className={`cursor-pointer p-4 rounded-xl border
${s.status==="completed"
?"border-emerald-500 bg-emerald-500/10"
:"border-red-500 bg-red-500/10"}`}>
<div className="font-bold">System #{s.id}</div>
<div className={`text-sm mt-2`}>
{s.status==="completed"?"ðŸŸ¢ Completed":"ðŸ”´ Not Completed"}
</div>
</div>
))}
</div>
</div>

{/* MODAL */}
{active && (
<div className="fixed inset-0 bg-black/70 flex items-center justify-center">
<div className="bg-slate-900 w-full max-w-2xl rounded-xl p-6 space-y-4">

<h2 className="text-2xl font-bold">System #{active.id}</h2>

<textarea
value={notes}
onChange={e=>setNotes(e.target.value)}
placeholder="Notes..."
className="w-full p-3 bg-slate-800 rounded-lg h-32"
/>

<input id="file-upload" type="file" multiple accept="image/*"/>

<div className="grid grid-cols-3 gap-3">
{photos.map((url,i)=>(
<div key={i} className="relative">
<img src={url} className="h-24 w-full object-cover rounded"/>
<button
onClick={()=>deletePhoto(url)}
className="absolute top-1 right-1 bg-red-600 px-2 text-xs rounded">
âœ•
</button>
</div>
))}
</div>

<div className="flex justify-end gap-3">
<button onClick={()=>setActive(null)}
className="px-4 py-2 bg-slate-700 rounded-lg">
Close
</button>

<button onClick={handleSave}
className="px-6 py-2 bg-emerald-600 rounded-lg">
{loading?"Saving...":"Save"}
</button>
</div>

</div>
</div>
)}

</div>
);
}

function Btn({label,onClick}){
return(
<button onClick={onClick}
className="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-800">
{label}
</button>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
