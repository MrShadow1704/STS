<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STS QAQC</title>

  <!-- React / Babel / Tailwind / Supabase -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    .fade { animation: fade .25s ease; }
    @keyframes fade {
      from { opacity:0; transform:scale(.95); }
      to { opacity:1; transform:scale(1); }
    }
  </style>
</head>

<body class="bg-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // TODO: if you regenerate keys, update here:
    const supabase = window.supabase.createClient(
      "https://bbgcsddwzcrxwzczrojf.supabase.co",
      "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f"
    );

    /* ============= AUTH COMPONENT ============= */
    function Auth({ onAuth }) {
      const [email, setEmail] = useState("");
      const [pass, setPass] = useState("");
      const [show, setShow] = useState(false);
      const [mode, setMode] = useState("login"); // "login" | "signup"
      const [msg, setMsg] = useState("");
      const [loading, setLoading] = useState(false);

      async function submit() {
        setMsg("");
        setLoading(true);

        // Basic guard to avoid 400s on empty fields
        if (!email || !pass) {
          setMsg("❌ Enter email and password");
          setLoading(false);
          return;
        }

        try {
          if (mode === "signup") {
            const { error } = await supabase.auth.signUp({
              email,
              password: pass,
              options: {
                // This redirect is harmless even when email confirmation is disabled
                emailRedirectTo: window.location.origin
              }
            });
            if (error) throw error;

            // If you have disabled "Confirm email" in Supabase,
            // user can now log in immediately. [web:1][web:2][web:5]
            setMsg("✅ Account created. You can login now.");
            setMode("login");
          } else {
            const { data, error } = await supabase.auth.signInWithPassword({
              email,
              password: pass
            }); // [web:21][web:23]
            if (error) throw error;
            onAuth(data.user);
          }
        } catch (e) {
          const message = e?.message || "Unknown error";

          if (message.toLowerCase().includes("invalid login")) {
            setMsg("❌ Invalid email or password");
          } else if (message.toLowerCase().includes("already")) {
            setMsg("⚠️ User already exists");
          } else if (message.toLowerCase().includes("email not confirmed")) {
            // This only appears if "Confirm email" is still ON in Supabase. [web:1][web:2][web:5]
            setMsg("⚠️ Supabase is still requiring email confirmation. Turn OFF 'Confirm email' in Authentication → Email provider.");
          } else {
            setMsg("❌ " + message);
          }
        }

        setLoading(false);
      }

      return (
        <div className="h-screen flex items-center justify-center">
          <div className="bg-white w-96 p-8 rounded-3xl shadow-xl fade space-y-4">
            <h1 className="text-2xl font-bold text-center text-blue-600">
              STS QAQC
            </h1>

            <input
              className="w-full border p-3 rounded-xl"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />

            <div className="relative">
              <input
                type={show ? "text" : "password"}
                className="w-full border p-3 rounded-xl pr-12"
                placeholder="Password"
                value={pass}
                onChange={(e) => setPass(e.target.value)}
              />
              <button
                type="button"
                onClick={() => setShow(!show)}
                className="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-500"
                aria-label={show ? "Hide password" : "Show password"}
              >
                {show ? (
                  /* eye-off icon */
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth="1.5"
                    stroke="currentColor"
                    className="w-5 h-5"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"
                    />
                  </svg>
                ) : (
                  /* eye icon */
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    strokeWidth="1.5"
                    stroke="currentColor"
                    className="w-5 h-5"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                    />
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                )}
              </button>
            </div>

            {msg && (
              <div className="text-sm text-center text-gray-700">
                {msg}
              </div>
            )}

            <button
              disabled={loading}
              onClick={submit}
              className="w-full bg-blue-600 text-white p-3 rounded-xl disabled:opacity-60"
            >
              {loading
                ? "Please wait..."
                : mode === "login"
                ? "Login"
                : "Create Account"}
            </button>

            <button
              type="button"
              onClick={() =>
                setMode(mode === "login" ? "signup" : "login")
              }
              className="w-full text-sm text-blue-600"
            >
              {mode === "login"
                ? "New user? Create account"
                : "Already have an account? Login"}
            </button>
          </div>
        </div>
      );
    }

    /* ============= DASHBOARD ============= */
    function Dashboard({ user }) {
      return (
        <div className="h-screen flex flex-col items-center justify-center space-y-4">
          <h2 className="text-2xl font-bold text-green-600">
            ✅ Login successful
          </h2>
          <p className="text-lg">
            Welcome, <b>{user?.email}</b>
          </p>
          <button
            onClick={() => supabase.auth.signOut()}
            className="px-6 py-3 bg-red-500 text-white rounded-xl"
          >
            Logout
          </button>
        </div>
      );
    }

    /* ============= ROOT ============= */
    function Root() {
      const [user, setUser] = useState(null);
      const [ready, setReady] = useState(false);

      useEffect(() => {
        supabase.auth.getUser().then((res) => {
          setUser(res.data.user);
          setReady(true);
        });

        const { data: listener } = supabase.auth.onAuthStateChange(
          (_, session) => {
            setUser(session?.user || null);
          }
        );

        return () => {
          listener.subscription.unsubscribe();
        };
      }, []);

      if (!ready) return null;
      return user ? (
        <Dashboard user={user} />
      ) : (
        <Auth onAuth={setUser} />
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Root />);
  </script>
</body>
</html>
