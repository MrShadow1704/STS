<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#f8fafc; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const SB_URL = "https://bbgcsddwzcrxwzczrojf.supabase.co";
const SB_KEY = "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f";
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

function App(){

const [systems,setSystems] = useState([]);
const [active,setActive] = useState(null);
const [notes,setNotes] = useState("");
const [photos,setPhotos] = useState([]);
const [status,setStatus] = useState("not_completed");
const [search,setSearch] = useState("");
const [filter,setFilter] = useState("all");
const [loading,setLoading] = useState(false);
const [showAdd,setShowAdd] = useState(false);
const [newId,setNewId] = useState("");

/* LOAD SYSTEMS */
useEffect(()=>{ loadSystems(); },[]);

async function loadSystems(){
  const { data } = await supabase
    .from("systems")
    .select("*")
    .order("id",{ ascending:true });
  setSystems(data || []);
}

/* REALTIME */
useEffect(()=>{
  const channel = supabase
    .channel("systems-live")
    .on("postgres_changes",
      { event:"*", schema:"public", table:"systems" },
      () => loadSystems()
    ).subscribe();

  return ()=> supabase.removeChannel(channel);
},[]);

/* OPEN SYSTEM */
useEffect(()=>{
  if(!active) return;
  setNotes(active.notes || "");
  setStatus(active.status || "not_completed");
  loadPhotos(active.id);
},[active]);

/* PHOTOS */
async function loadPhotos(id){
  const { data } = await supabase.storage.from("photos").list(id);
  if(!data){ setPhotos([]); return; }

  const urls = data.map(f=>{
    const { data:{ publicUrl }} =
      supabase.storage.from("photos")
      .getPublicUrl(`${id}/${f.name}`);
    return publicUrl;
  });
  setPhotos(urls);
}

async function deletePhoto(url){
  const path = url.split("/photos/")[1];
  await supabase.storage.from("photos").remove([path]);
  loadPhotos(active.id);
}

/* SAVE */
async function handleSave(){
  setLoading(true);
  const input = document.getElementById("file-upload");

  if(input.files.length){
    for(const f of input.files){
      const path = `${active.id}/${Date.now()}_${f.name}`;
      await supabase.storage.from("photos").upload(path,f,{upsert:true});
    }
  }

  const finalStatus =
    notes.trim() || input.files.length
    ? "completed"
    : status;

  await supabase
    .from("systems")
    .update({ notes, status: finalStatus })
    .eq("id",active.id);

  input.value="";
  setStatus(finalStatus);
  loadPhotos(active.id);
  setLoading(false);
}

/* ADD SYSTEM */
async function createSystem(){
  if(!newId.trim()) return;

  await supabase.from("systems").insert([{
    id:newId.trim(),
    notes:"",
    status:"not_completed"
  }]);

  setNewId("");
  setShowAdd(false);
}

/* FILTER */
const filtered = systems.filter(s =>
  s.id.toLowerCase().includes(search.toLowerCase()) &&
  (filter==="all" || s.status===filter)
);

return(
<div className="flex h-screen">

{/* SIDEBAR */}
<div className="w-64 bg-white border-r p-4 flex flex-col">
<h1 className="text-xl font-bold text-blue-600">STS QAQC</h1>
<p className="text-xs text-gray-400 mb-4">Quality Control System</p>

<button
onClick={()=>setShowAdd(true)}
className="bg-blue-600 text-white py-2 rounded-lg mb-4">
+ Add System
</button>

<div className="space-y-2 text-sm">
<button onClick={()=>setFilter("all")} className="sidebar-btn">ğŸ“ All</button>
<button onClick={()=>setFilter("completed")} className="sidebar-btn">âœ… Completed</button>
<button onClick={()=>setFilter("not_completed")} className="sidebar-btn">âŒ Not Completed</button>
</div>

<div className="mt-auto p-3 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-100 text-xs text-gray-600">
âš™ï¸ Smart QAQC Dashboard  
ğŸ“Š Live Collaboration  
ğŸ“· Photo Evidence  
</div>
</div>

{/* MAIN */}
<div className="flex-1 p-6 overflow-y-auto">

<div className="flex gap-4 mb-4">
<input
className="flex-1 border p-3 rounded-lg"
placeholder="Search system..."
onChange={e=>setSearch(e.target.value)}
/>

<select
className="border p-3 rounded-lg"
onChange={e=>setFilter(e.target.value)}>
<option value="all">All</option>
<option value="completed">Completed</option>
<option value="not_completed">Not Completed</option>
</select>
</div>

<div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
{filtered.map(s=>(
<div
key={s.id}
onClick={()=>setActive(s)}
className={`cursor-pointer border rounded-xl p-4 transition hover:shadow
${s.status==="completed"
?"border-green-500 bg-green-50"
:"border-red-400 bg-red-50"}`}>
<div className="font-bold">System #{s.id}</div>
<div className="text-sm mt-2">
{s.status==="completed"?"ğŸŸ¢ Completed":"ğŸ”´ Not Completed"}
</div>
</div>
))}
</div>
</div>

{/* SYSTEM MODAL */}
{active && (
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white w-full max-w-2xl rounded-2xl p-6 space-y-4 shadow-xl">

<h2 className="text-xl font-bold">System #{active.id}</h2>

<textarea
value={notes}
onChange={e=>setNotes(e.target.value)}
placeholder="Inspection notes..."
className="w-full border p-3 rounded-xl h-28"
/>

<input id="file-upload" type="file" multiple accept="image/*" />

<div className="grid grid-cols-3 gap-3">
{photos.map((url,i)=>(
<div key={i} className="relative group">
<img src={url} className="h-24 w-full object-cover rounded-lg"/>
<div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex gap-2 items-center justify-center rounded-lg">
<a href={url} download className="bg-white px-2 py-1 text-xs rounded">â¬‡</a>
<button onClick={()=>deletePhoto(url)}
className="bg-red-600 text-white px-2 py-1 text-xs rounded">âœ•</button>
</div>
</div>
))}
</div>

<div className="flex justify-end gap-3">
<button onClick={()=>setActive(null)} className="px-4 py-2 border rounded-lg">
Close
</button>
<button onClick={handleSave}
className="px-6 py-2 bg-blue-600 text-white rounded-lg">
{loading?"Saving...":"Save"}
</button>
</div>

</div>
</div>
)}

{/* ADD SYSTEM MODAL */}
{showAdd && (
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white p-6 rounded-2xl w-96 space-y-4">
<h2 className="text-lg font-bold">Add New System</h2>

<input
value={newId}
onChange={e=>setNewId(e.target.value)}
placeholder="System number"
className="w-full border p-3 rounded-lg"
/>

<div className="flex justify-end gap-3">
<button onClick={()=>setShowAdd(false)} className="px-4 py-2 border rounded-lg">
Cancel
</button>
<button onClick={createSystem} className="px-6 py-2 bg-blue-600 text-white rounded-lg">
Add
</button>
</div>
</div>
</div>
)}

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
