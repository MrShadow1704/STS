<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Live Notepad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-4 md:p-10">

    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden flex flex-col md:flex-row h-[80vh]">
        
        <div class="w-full md:w-1/3 border-r flex flex-col">
            <div class="p-4 bg-gray-800 text-white">
                <input type="text" id="search" placeholder="Search system #..." class="w-full p-2 rounded text-black">
            </div>
            <div id="list" class="overflow-y-auto flex-1"></div>
        </div>

        <div id="editor" class="w-full md:w-2/3 p-6 hidden">
            <h2 class="text-2xl font-bold mb-4 text-blue-600">System #<span id="sys-id"></span></h2>
            
            <label class="block mb-2 font-bold">Notes:</label>
            <textarea id="notes-text" class="w-full p-3 border rounded mb-4 h-32" placeholder="Write result here..."></textarea>
            
            <label class="block mb-2 font-bold">Photo Evidence:</label>
            <input type="file" id="file-input" class="mb-4 block w-full text-sm">
            
            <div id="download-area" class="mb-6 p-3 bg-green-50 rounded hidden border border-green-200">
                <p class="text-green-700 text-sm font-bold">âœ“ Attachment Available:</p>
                <a id="download-link" href="#" target="_blank" class="text-blue-600 underline font-medium">Click to Download/View Photo</a>
            </div>

            <button id="save-btn" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">Save Update</button>
        </div>

        <div id="empty" class="w-full md:w-2/3 flex items-center justify-center text-gray-400">
            Select a system to view results
        </div>
    </div>

    <script>
        // PASTE YOUR KEYS HERE
        const SB_URL = 'https://bbgcsddwzcrxwzczrojf.supabase.co';
        const SB_KEY = 'sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f';
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        let activeId = null;

        async function load() {
            const { data } = await supabase.from('systems').select('*').order('id');
            const term = document.getElementById('search').value;
            const list = document.getElementById('list');
            list.innerHTML = '';

            data.filter(s => s.id.includes(term)).forEach(s => {
                const isDone = s.notes || s.has_attachment;
                const div = document.createElement('div');
                div.className = `p-4 border-b cursor-pointer flex justify-between ${activeId === s.id ? 'bg-blue-100' : ''}`;
                div.innerHTML = `<span>#${s.id}</span> <span class="w-3 h-3 rounded-full ${isDone ? 'bg-green-500' : 'bg-red-500'}"></span>`;
                div.onclick = () => { activeId = s.id; show(s); };
                list.appendChild(div);
            });
        }

        function show(s) {
            document.getElementById('empty').classList.add('hidden');
            document.getElementById('editor').classList.remove('hidden');
            document.getElementById('sys-id').innerText = s.id;
            document.getElementById('notes-text').value = s.notes || '';
            
            const dl = document.getElementById('download-area');
            if (s.has_attachment) {
                dl.classList.remove('hidden');
                // This assumes your image is named system_id.jpg in the 'photos' bucket
                document.getElementById('download-link').href = `${SB_URL}/storage/v1/object/public/photos/${s.id}.jpg`;
            } else {
                dl.classList.add('hidden');
            }
        }

        document.getElementById('save-btn').onclick = async () => {
            const file = document.getElementById('file-input').files[0];
            let has_attachment = activeId ? (await supabase.from('systems').select('has_attachment').eq('id', activeId).single()).data.has_attachment : false;

            if (file) {
                await supabase.storage.from('photos').upload(`${activeId}.jpg`, file, { upsert: true });
                has_attachment = true;
            }

            await supabase.from('systems').update({ 
                notes: document.getElementById('notes-text').value,
                has_attachment: has_attachment
            }).eq('id', activeId);

            alert("Saved!");
            load();
        };

        document.getElementById('search').oninput = load;
        load();
        // Live sync
        supabase.channel('room1').on('postgres_changes', {event:'*', schema:'public', table:'systems'}, load).subscribe();
    </script>
</body>
</html>
