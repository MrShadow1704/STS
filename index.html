<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#f8fafc; }
.fade-in {
  animation: fadeIn .25s ease-out;
}
@keyframes fadeIn {
  from { opacity:0; transform:scale(.95); }
  to { opacity:1; transform:scale(1); }
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const SB_URL = "https://bbgcsddwzcrxwzczrojf.supabase.co";
const SB_KEY = "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f";
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

function App(){

const [systems,setSystems] = useState([]);
const [active,setActive] = useState(null);
const [notes,setNotes] = useState("");
const [photos,setPhotos] = useState([]);
const [search,setSearch] = useState("");
const [filter,setFilter] = useState("all");
const [loading,setLoading] = useState(false);
const [showAdd,setShowAdd] = useState(false);
const [newId,setNewId] = useState("");

useEffect(()=>{ loadSystems(); },[]);
async function loadSystems(){
  const { data } = await supabase.from("systems").select("*").order("id");
  setSystems(data||[]);
}

useEffect(()=>{
  const channel = supabase
    .channel("systems-live")
    .on("postgres_changes",{event:"*",schema:"public",table:"systems"},loadSystems)
    .subscribe();
  return()=>supabase.removeChannel(channel);
},[]);

useEffect(()=>{
  if(!active) return;
  setNotes(active.notes||"");
  loadPhotos(active.id);
},[active]);

async function loadPhotos(id){
  const { data } = await supabase.storage.from("photos").list(id);
  if(!data){setPhotos([]);return;}
  setPhotos(data.map(f=>{
    const {data:{publicUrl}} =
      supabase.storage.from("photos").getPublicUrl(`${id}/${f.name}`);
    return publicUrl;
  }));
}

async function deletePhoto(url){
  const path = url.split("/photos/")[1];
  await supabase.storage.from("photos").remove([path]);
  loadPhotos(active.id);
}

async function handleSave(){
  setLoading(true);
  const input=document.getElementById("file-upload");

  if(input.files.length){
    for(const f of input.files){
      const path=`${active.id}/${Date.now()}_${f.name}`;
      await supabase.storage.from("photos").upload(path,f,{upsert:true});
    }
  }

  await supabase.from("systems")
    .update({notes,status:"completed"})
    .eq("id",active.id);

  input.value="";
  loadPhotos(active.id);
  setLoading(false);
}

async function createSystem(){
  if(!newId.trim()) return;
  await supabase.from("systems")
    .insert([{id:newId.trim(),notes:"",status:"not_completed"}]);
  setNewId(""); setShowAdd(false);
}

const filtered=systems.filter(s=>
  s.id.toLowerCase().includes(search.toLowerCase()) &&
  (filter==="all"||s.status===filter)
);

return(
<div className="flex h-screen">

{/* SIDEBAR */}
<div className="w-80 bg-white border-r p-6 flex flex-col">
<h1 className="text-2xl font-bold text-blue-600">STS QAQC</h1>
<p className="text-sm text-gray-500 mb-8">Quality Dashboard</p>

<button onClick={()=>setShowAdd(true)}
className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-2xl font-semibold mb-8 hover:scale-[1.02] transition">
+ Add System
</button>

<div className="flex flex-col gap-4 text-base">
<button onClick={()=>setFilter("all")} className="sidebarBtn">ğŸ“ All Systems</button>
<button onClick={()=>setFilter("completed")} className="sidebarBtn">âœ… Completed</button>
<button onClick={()=>setFilter("not_completed")} className="sidebarBtn">âŒ Not Completed</button>
</div>

<div className="mt-auto rounded-3xl bg-gradient-to-br from-blue-100 to-indigo-200 p-6 text-sm text-gray-700">
<div className="font-bold mb-2">Smart QA/QC</div>
<p>Realtime collaboration<br/>Photo evidence<br/>Progress tracking</p>
</div>
</div>

{/* MAIN */}
<div className="flex-1 p-10 overflow-y-auto">

<div className="flex gap-4 mb-8">
<input className="flex-1 border p-4 rounded-2xl"
placeholder="Search system..."
onChange={e=>setSearch(e.target.value)}/>
<select className="border p-4 rounded-2xl" onChange={e=>setFilter(e.target.value)}>
<option value="all">All</option>
<option value="completed">Completed</option>
<option value="not_completed">Not Completed</option>
</select>
</div>

<div className="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6">
{filtered.map(s=>(
<div key={s.id} onClick={()=>setActive(s)}
className={`cursor-pointer p-6 rounded-3xl border shadow hover:shadow-xl hover:-translate-y-1 transition
${s.status==="completed"?"bg-green-50 border-green-500":"bg-red-50 border-red-400"}`}>
<h3 className="font-bold text-lg">System #{s.id}</h3>
<p className="mt-2 text-sm">
{s.status==="completed"?"ğŸŸ¢ Completed":"ğŸ”´ Not Completed"}
</p>
</div>
))}
</div>
</div>

{/* SYSTEM MODAL */}
{active&&(
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white w-full max-w-4xl rounded-[32px] p-8 shadow-2xl fade-in">

<div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl p-6 mb-6">
<h2 className="text-2xl font-bold">System #{active.id}</h2>
<p className="text-sm opacity-80">Inspection & Documentation</p>
</div>

<textarea value={notes} onChange={e=>setNotes(e.target.value)}
className="w-full border p-5 rounded-2xl h-36 mb-4"
placeholder="Inspection notes..."/>

<input id="file-upload" type="file" multiple className="mb-6"/>

<div className="grid grid-cols-3 gap-5 mb-6">
{photos.map((url,i)=>(
<div key={i} className="border rounded-2xl p-2">
<a href={url} target="_blank">
<img src={url} className="h-32 w-full object-cover rounded-xl cursor-pointer"/>
</a>
<div className="flex gap-2 mt-3">
<a href={url} download
className="flex-1 bg-blue-600 text-white py-2 rounded-xl text-sm text-center">
â¬‡ Download
</a>
<button onClick={()=>deletePhoto(url)}
className="flex-1 bg-red-600 text-white py-2 rounded-xl text-sm">
ğŸ—‘ Delete
</button>
</div>
</div>
))}
</div>

<div className="flex justify-end gap-4">
<button onClick={()=>setActive(null)} className="px-6 py-3 border rounded-xl">Close</button>
<button onClick={handleSave}
className="px-8 py-3 bg-blue-600 text-white rounded-xl">
{loading?"Saving...":"Save"}
</button>
</div>

</div>
</div>
)}

{/* ADD SYSTEM MODAL */}
{showAdd&&(
<div className="fixed inset-0 bg-black/40 flex items-center justify-center">
<div className="bg-white w-96 rounded-[32px] p-8 shadow-2xl fade-in">
<h2 className="text-xl font-bold mb-4">Add New System</h2>
<input value={newId} onChange={e=>setNewId(e.target.value)}
className="w-full border p-4 rounded-2xl mb-6"
placeholder="System Number"/>
<div className="flex justify-end gap-4">
<button onClick={()=>setShowAdd(false)} className="px-4 py-2 border rounded-xl">Cancel</button>
<button onClick={createSystem}
className="px-6 py-2 bg-blue-600 text-white rounded-xl">Add</button>
</div>
</div>
</div>
)}

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
