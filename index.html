<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Pro Navigator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // TODO: put your real Supabase values here
        const SB_URL = 'https://bbgcsddwzcrxwzczrojf.supabase.co';
        const SB_KEY = 'sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f';

        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        function App() {
            const [systems, setSystems] = useState([]);
            const [activeSys, setActiveSys] = useState(null);
            const [notes, setNotes] = useState("");
            const [photos, setPhotos] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                loadData();
            }, []);

            async function loadData() {
                const { data, error } = await supabase
                    .from('systems')
                    .select('*')
                    .order('id');

                if (error) {
                    console.error('Error loading systems:', error);
                    setSystems([]);
                    return;
                }

                setSystems(data || []);
            }

            useEffect(() => {
                if (activeSys) {
                    setNotes(activeSys.notes || "");
                    fetchPhotos(activeSys.id);
                } else {
                    setPhotos([]);
                }
            }, [activeSys]);

            async function fetchPhotos(id) {
                // List all files in bucket root (bucket: photos)
                const { data, error } = await supabase.storage
                    .from('photos')
                    .list('', {
                        limit: 100,
                        sortBy: { column: 'name', order: 'desc' },
                    });

                if (error) {
                    console.error('Error listing photos:', error);
                    setPhotos([]);
                    return;
                }

                const allFiles = data || [];

                // Only take files belonging to this system, based on prefix "id_"
                const filtered = allFiles.filter((f) =>
                    f.name.startsWith(`${id}_`)
                );

                const urls = filtered.map((file) => {
                    const { data: publicData } = supabase.storage
                        .from('photos')
                        .getPublicUrl(file.name); // same path as upload

                    // cache-buster to avoid stale images
                    return `${publicData.publicUrl}?t=${Date.now()}`;
                });

                setPhotos(urls);
            }

            async function handleSave() {
                if (!activeSys) return;

                setLoading(true);

                const fileInput = document.getElementById('file-upload');
                const files = fileInput?.files;
                let hasAttach = !!activeSys.has_attachment;

                // Upload new files if any
                if (files && files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        const fileName = `${activeSys.id}_${Date.now()}_${i}.jpg`;

                        const { error: uploadError } = await supabase.storage
                            .from('photos')
                            .upload(fileName, files[i]); // root of bucket, no folder

                        if (uploadError) {
                            console.error('Upload error:', uploadError);
                        } else {
                            hasAttach = true;
                        }
                    }
                }

                // Update DB record
                const { error } = await supabase
                    .from('systems')
                    .update({ notes, has_attachment: hasAttach })
                    .eq('id', activeSys.id);

                if (error) {
                    console.error('Error updating system:', error);
                    setLoading(false);
                    return;
                }

                // Keep local state in sync
                const updatedSys = { ...activeSys, notes, has_attachment: hasAttach };
                setActiveSys(updatedSys);

                // Refresh list and photos
                await loadData();
                await fetchPhotos(activeSys.id);

                // Clear file input
                if (fileInput) {
                    fileInput.value = "";
                }

                setLoading(false);
            }

            async function deleteSystem() {
                if (!activeSys) return;
                if (!confirm("Are you sure? This will delete all notes for this unit.")) return;

                await supabase.from('systems').delete().eq('id', activeSys.id);
                setActiveSys(null);
                loadData();
            }

            async function addSystem() {
                const id = prompt("Enter new System ID:");
                if (!id) return;

                const { error } = await supabase
                    .from('systems')
                    .insert([{ id }]);

                if (error) {
                    alert("ID might already exist");
                } else {
                    loadData();
                }
            }

            return (
                <div className="flex h-screen w-full overflow-hidden bg-slate-50">
                    {/* SIDEBAR */}
                    <aside className="w-80 border-r bg-white flex flex-col shadow-xl z-10">
                        <div className="p-6 space-y-4">
                            <button
                                onClick={addSystem}
                                className="w-full bg-emerald-500 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-lg shadow-emerald-100 hover:bg-emerald-600 transition-all"
                            >
                                + Add System
                            </button>
                            <input
                                className="w-full bg-slate-100 p-4 rounded-xl text-sm outline-none border-2 border-transparent focus:border-emerald-400"
                                placeholder="Search units..."
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scroll px-4 pb-6 space-y-2">
                            {systems
                                .filter((s) =>
                                    s.id
                                        .toString()
                                        .toLowerCase()
                                        .includes(searchTerm.toLowerCase())
                                )
                                .map((s) => (
                                    <div
                                        key={s.id}
                                        onClick={() => setActiveSys(s)}
                                        className={`p-5 rounded-2xl cursor-pointer transition-all border-2 ${
                                            activeSys?.id === s.id
                                                ? 'border-emerald-500 bg-emerald-50'
                                                : 'border-transparent bg-slate-50 hover:bg-slate-100'
                                        }`}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-slate-800">
                                                #{s.id}
                                            </span>
                                            {(s.notes || s.has_attachment) && (
                                                <div className="w-2 h-2 bg-emerald-500 rounded-full status-pulse"></div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                        </div>
                    </aside>

                    {/* WORKSPACE */}
                    <main className="flex-1 overflow-y-auto custom-scroll bg-white">
                        {activeSys ? (
                            <div className="p-8 md:p-16 max-w-4xl mx-auto space-y-12">
                                <div className="flex justify-between items-start border-b pb-8">
                                    <div>
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                            Editing Mode
                                        </p>
                                        <h2 className="text-6xl font-black tracking-tighter text-slate-900 leading-none">
                                            SYS_{activeSys.id}
                                        </h2>
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={deleteSystem}
                                            className="bg-rose-50 text-rose-500 px-6 py-4 rounded-2xl font-bold text-xs hover:bg-rose-100 transition-all"
                                        >
                                            Delete
                                        </button>
                                        <button
                                            onClick={handleSave}
                                            disabled={loading}
                                            className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-emerald-600 transition-all shadow-xl disabled:opacity-60"
                                        >
                                            {loading ? "Saving..." : "Save"}
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <label className="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">
                                        Notes & Findings
                                    </label>
                                    <textarea
                                        className="w-full h-56 bg-slate-50 border-none rounded-[2rem] p-8 text-xl text-slate-700 outline-none focus:ring-4 focus:ring-emerald-50 transition-all"
                                        value={notes}
                                        onChange={(e) => setNotes(e.target.value)}
                                        placeholder="Type data here..."
                                    />
                                </div>

                                <div className="space-y-6">
                                    <div className="flex justify-between items-center">
                                        <label className="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">
                                            Media Evidence ({photos.length})
                                        </label>
                                        <div className="relative">
                                            <span className="text-emerald-500 text-xs font-bold cursor-pointer">
                                                + Attach Photos
                                            </span>
                                            <input
                                                type="file"
                                                id="file-upload"
                                                multiple
                                                className="absolute inset-0 opacity-0 cursor-pointer"
                                            />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-6">
                                        {photos.map((url, i) => (
                                            <div
                                                key={i}
                                                className="aspect-square rounded-[2rem] overflow-hidden bg-slate-100 border-4 border-slate-50 group relative"
                                            >
                                                <img
                                                    src={url}
                                                    className="w-full h-full object-cover"
                                                />
                                                <a
                                                    href={url}
                                                    target="_blank"
                                                    rel="noreferrer"
                                                    className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-[10px] font-bold uppercase"
                                                >
                                                    View
                                                </a>
                                            </div>
                                        ))}
                                        <div className="aspect-square bg-slate-50 border-4 border-dashed border-slate-200 rounded-[2rem] flex items-center justify-center text-slate-300">
                                            <p className="text-[10px] font-black uppercase">
                                                Ready for upload
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="h-full flex items-center justify-center text-slate-200 uppercase font-black tracking-widest">
                                Select a system to begin work
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
