<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>STS QAQC</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#0f172a; color:#e2e8f0; }
.success-flash { animation: flash .8s ease; }
@keyframes flash {
0%{background:#022c22;}
50%{background:#065f46;}
100%{background:#0f172a;}
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const SB_URL = "https://bbgcsddwzcrxwzczrojf.supabase.co";
const SB_KEY = "sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f";
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

function App(){

const [systems,setSystems]=useState([]);
const [active,setActive]=useState(null);
const [notes,setNotes]=useState("");
const [photos,setPhotos]=useState([]);
const [loading,setLoading]=useState(false);
const [flash,setFlash]=useState(false);
const [search,setSearch]=useState("");

useEffect(()=>{loadSystems()},[]);

async function loadSystems(){
const {data,error}=await supabase.from("systems").select("*").order("id");
if(error) console.error(error);
setSystems(data||[]);
}

useEffect(()=>{
if(active){
setNotes(active.notes||"");
fetchPhotos(active.id);
}else{
setPhotos([]);
}
},[active]);

/* FETCH PHOTOS */
async function fetchPhotos(id){

const {data,error}=await supabase.storage
.from("photos")
.list(id);

if(error){
console.error("List error:",error);
setPhotos([]);
return;
}

if(!data || data.length===0){
setPhotos([]);
return;
}

const urls=data.map(file=>{
const {data:{publicUrl}}=
supabase.storage.from("photos")
.getPublicUrl(`${id}/${file.name}`);
return publicUrl + `?t=${Date.now()}`;
});

setPhotos(urls);
}

/* SAVE */
async function handleSave(){

if(!active) return;
setLoading(true);

const input=document.getElementById("file-upload");
const files=input?.files;

let hasAttach = active.has_attachment || false;

if(files && files.length>0){

for(let i=0;i<files.length;i++){

const path=`${active.id}/${Date.now()}_${files[i].name}`;

const {error}=await supabase.storage
.from("photos")
.upload(path,files[i],{upsert:true});

if(error){
console.error("Upload error:",error);
}else{
hasAttach=true;
}
}
}

const {error:updateError}=await supabase
.from("systems")
.update({notes,has_attachment:hasAttach})
.eq("id",active.id);

if(updateError) console.error(updateError);

await fetchPhotos(active.id);
await loadSystems();

if(input) input.value="";

setFlash(true);
setTimeout(()=>setFlash(false),800);

setLoading(false);
}

/* ADD SYSTEM */
async function addSystem(){
const id=prompt("Enter System ID:");
if(!id) return;

const {error}=await supabase
.from("systems")
.insert([{id,notes:"",has_attachment:false}]);

if(error) alert("ID already exists");
else loadSystems();
}

/* DELETE SYSTEM */
async function deleteSystem(){
if(!confirm("Delete this system?")) return;
await supabase.from("systems").delete().eq("id",active.id);
setActive(null);
loadSystems();
}

return(
<div className={`flex h-screen ${flash?"success-flash":""}`}>

{/* SIDEBAR */}
<div className="w-72 bg-slate-950 border-r border-slate-800 flex flex-col">

<div className="p-6 border-b border-slate-800">
<h1 className="text-2xl font-bold text-emerald-400">
STS QAQC
</h1>
<p className="text-xs text-slate-500">Quality Dashboard</p>
</div>

<div className="p-4 space-y-3">
<button onClick={addSystem}
className="w-full bg-emerald-600 hover:bg-emerald-500 py-2 rounded-lg text-sm font-semibold transition">
+ Add System
</button>

<input
placeholder="Search..."
className="w-full bg-slate-800 p-2 rounded-lg text-sm outline-none"
onChange={e=>setSearch(e.target.value)}
/>
</div>

<div className="flex-1 overflow-y-auto px-3 space-y-2 pb-4">
{systems
.filter(s=>s.id.toLowerCase().includes(search.toLowerCase()))
.map(s=>(
<div key={s.id}
onClick={()=>setActive(s)}
className={`p-3 rounded-lg cursor-pointer transition flex justify-between items-center
${active?.id===s.id?"bg-emerald-600/20 border border-emerald-500":"bg-slate-800 hover:bg-slate-700"}`}>

<span>#{s.id}</span>

{s.has_attachment &&
<span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>}

</div>
))}
</div>
</div>

{/* MAIN */}
<div className="flex-1 p-10 overflow-y-auto">

{active?(
<div className="max-w-4xl mx-auto space-y-8">

<div className="flex justify-between items-center">
<h2 className="text-3xl font-bold">
System #{active.id}
</h2>

<div className="flex gap-3">
<button onClick={deleteSystem}
className="bg-red-500/20 text-red-400 px-4 py-2 rounded-lg text-sm">
Delete
</button>

<button onClick={handleSave}
className="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-lg text-sm font-semibold transition">
{loading?"Saving...":"Save"}
</button>
</div>
</div>

<div>
<label className="text-sm text-slate-400">Inspection Notes</label>
<textarea
value={notes}
onChange={e=>setNotes(e.target.value)}
className="w-full mt-2 p-4 rounded-xl bg-slate-800 h-40 outline-none focus:ring-2 focus:ring-emerald-500"
/>
</div>

<div>
<div className="flex justify-between items-center mb-3">
<label className="text-sm text-slate-400">
Attachments ({photos.length})
</label>

<div className="relative">
<span className="text-emerald-400 text-sm cursor-pointer">
+ Upload
</span>
<input type="file"
id="file-upload"
multiple
className="absolute inset-0 opacity-0 cursor-pointer"/>
</div>
</div>

<div className="grid grid-cols-2 md:grid-cols-4 gap-4">
{photos.map((url,i)=>(
<div key={i}
className="rounded-lg overflow-hidden bg-slate-800">
<img src={url}
className="w-full h-32 object-cover"/>
</div>
))}
</div>
</div>

</div>
):(
<div className="h-full flex items-center justify-center text-slate-600">
Select a system to begin
</div>
)}

</div>

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
