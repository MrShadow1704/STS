<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Systems Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .system-item:hover { transform: translateX(4px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.5)]"></div>
            <h1 class="text-xl font-bold tracking-tight text-slate-800 uppercase italic">Live QA Monitor</h1>
        </div>
        <div id="status-chip" class="text-xs font-bold px-3 py-1 rounded-full bg-slate-100 text-slate-500 uppercase">Connecting...</div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-white border-r flex flex-col shadow-inner">
            <div class="p-4">
                <input type="text" id="search" placeholder="Search system #..." 
                    class="w-full px-4 py-3 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-400">
            </div>
            <div id="list" class="flex-1 overflow-y-auto custom-scroll px-3 pb-4 space-y-1">
                </div>
        </aside>

        <section class="flex-1 overflow-y-auto p-8 lg:p-12 flex justify-center bg-[#f8fafc]">
            <div id="editor" class="w-full max-w-3xl hidden">
                <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                    <div class="px-8 py-6 border-b border-slate-50 flex justify-between items-center bg-white">
                        <h2 class="text-3xl font-black text-slate-800">SYSTEM <span id="sys-id" class="text-blue-600">--</span></h2>
                        <span id="badge" class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest"></span>
                    </div>

                    <div class="p-8">
                        <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3">Test Observations</label>
                        <textarea id="notes" rows="6" 
                            class="w-full p-5 border border-slate-100 rounded-2xl bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all text-slate-700 text-lg leading-relaxed mb-8" 
                            placeholder="Type results here..."></textarea>

                        <div id="attachment-area">
                            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3">Supporting Evidence</label>
                            
                            <div id="dl-box" class="hidden mb-6 p-5 bg-blue-600 rounded-2xl flex items-center justify-between text-white shadow-lg shadow-blue-200">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ðŸ“¸</span>
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm">Attachment Found</span>
                                        <span class="text-[10px] opacity-70">IMAGE_FILE_#<span id="sys-id-file"></span></span>
                                    </div>
                                </div>
                                <a id="dl-link" href="#" target="_blank" class="bg-white text-blue-600 px-4 py-2 rounded-xl font-black text-xs uppercase hover:bg-slate-100 transition-colors">Open File</a>
                            </div>

                            <div class="relative group border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center hover:border-blue-400 hover:bg-blue-50/50 transition-all cursor-pointer">
                                <p class="text-slate-400 font-bold group-hover:text-blue-500">Drop file here or click to upload</p>
                                <input type="file" id="file-input" class="absolute inset-0 opacity-0 cursor-pointer">
                            </div>
                        </div>

                        <button id="save-btn" 
                            class="mt-10 w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg hover:bg-blue-600 hover:shadow-2xl hover:shadow-blue-200 transition-all active:scale-[0.97] uppercase tracking-widest">
                            Save & Push Update
                        </button>
                    </div>
                </div>
            </div>

            <div id="empty" class="flex flex-col items-center justify-center text-slate-300">
                <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-10 h-10 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                </div>
                <p class="text-lg font-bold uppercase tracking-widest opacity-40 italic">Select System ID</p>
            </div>
        </section>
    </main>

    <script>
        // --- IMPORTANT: Update these keys carefully ---
        const DB_URL = https://bbgcsddwzcrxwzczrojf.supabase.co;
        const DB_KEY = sb_publishable_678Ol2HCLnEtOJNwly0vDg_XQS9f72f;
        
        // Using a unique variable name to avoid 'already declared' error
        const appClient = window.supabase.createClient(DB_URL, DB_KEY);

        let selectedId = null;

        async function updateDashboard() {
            try {
                const { data, error } = await appClient.from('systems').select('*').order('id');
                if (error) throw error;

                document.getElementById('status-chip').innerText = "âœ… Systems Live";
                document.getElementById('status-chip').className = "text-[10px] font-black px-3 py-1 rounded-full bg-green-100 text-green-600 uppercase";

                const search = document.getElementById('search').value;
                const list = document.getElementById('list');
                list.innerHTML = '';

                data.filter(s => s.id.includes(search)).forEach(s => {
                    const isDone = s.notes || s.has_attachment;
                    const isActive = selectedId === s.id;
                    const div = document.createElement('div');
                    
                    div.className = `system-item p-4 rounded-2xl cursor-pointer flex justify-between items-center transition-all duration-200 ${isActive ? 'bg-blue-600 text-white shadow-xl shadow-blue-200 scale-[1.02]' : 'hover:bg-slate-100'}`;
                    
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-black text-xs uppercase ${isActive ? 'opacity-50' : 'text-slate-300'}">ID</span>
                            <span class="font-black text-xl">#${s.id}</span>
                        </div>
                        <div class="h-4 w-4 rounded-full border-4 ${isActive ? 'border-blue-500 bg-white' : (isDone ? 'bg-green-500 border-white' : 'bg-slate-200 border-white')}"></div>
                    `;
                    div.onclick = () => { selectedId = s.id; openEditor(s); };
                    list.appendChild(div);
                });
            } catch (err) {
                document.getElementById('status-chip').innerText = "âŒ DB Error";
                document.getElementById('status-chip').className = "text-[10px] font-black px-3 py-1 rounded-full bg-red-100 text-red-600 uppercase";
            }
        }

        function openEditor(s) {
            document.getElementById('empty').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
            document.getElementById('sys-id').innerText = s.id;
            document.getElementById('sys-id-file').innerText = s.id;
            document.getElementById('notes').value = s.notes || '';
            
            const badge = document.getElementById('badge');
            const isDone = s.notes || s.has_attachment;
            badge.innerText = isDone ? 'System Cleared' : 'Action Required';
            badge.className = `px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest ${isDone ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-600'}`;

            const box = document.getElementById('dl-box');
            if (s.has_attachment) {
                box.classList.remove('hidden');
                document.getElementById('dl-link').href = `${DB_URL}/storage/v1/object/public/photos/${s.id}.jpg`;
            } else {
                box.classList.add('hidden');
            }
            updateDashboard();
        }

        document.getElementById('save-btn').onclick = async () => {
            const btn = document.getElementById('save-btn');
            btn.innerText = "PUSHING DATA...";
            btn.disabled = true;

            const file = document.getElementById('file-input').files[0];
            let attachmentFound = false;

            // Check existing status
            const { data } = await appClient.from('systems').select('has_attachment').eq('id', selectedId).single();
            attachmentFound = data?.has_attachment || false;

            if (file) {
                await appClient.storage.from('photos').upload(`${selectedId}.jpg`, file, { upsert: true });
                attachmentFound = true;
            }

            await appClient.from('systems').update({ 
                notes: document.getElementById('notes').value,
                has_attachment: attachmentFound
            }).eq('id', selectedId);

            btn.innerText = "Save & Push Update";
            btn.disabled = false;
            updateDashboard();
        };

        document.getElementById('search').oninput = updateDashboard;
        
        // Start app
        updateDashboard();
        
        // Real-time polling
        setInterval(updateDashboard, 10000);
    </script>
</body>
</html>
